<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Chat Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        /* Markdown styling */
        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3,
        .message.assistant .message-content h4,
        .message.assistant .message-content h5,
        .message.assistant .message-content h6 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.25;
        }

        .message.assistant .message-content h1 {
            font-size: 1.5em;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 0.3em;
        }

        .message.assistant .message-content h2 {
            font-size: 1.3em;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 0.3em;
        }

        .message.assistant .message-content h3 {
            font-size: 1.1em;
        }

        .message.assistant .message-content p {
            margin-bottom: 0.8em;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin: 0.8em 0;
            padding-left: 2em;
        }

        .message.assistant .message-content li {
            margin: 0.3em 0;
        }

        .message.assistant .message-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }

        .message.assistant .message-content pre {
            background: #282c34;
            color: #abb2bf;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.8em 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
            line-height: 1.5;
        }

        .message.assistant .message-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
            font-size: inherit;
        }

        .message.assistant .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1em;
            margin: 0.8em 0;
            color: #666;
            font-style: italic;
        }

        .message.assistant .message-content table {
            border-collapse: collapse;
            margin: 0.8em 0;
            width: 100%;
        }

        .message.assistant .message-content table th,
        .message.assistant .message-content table td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }

        .message.assistant .message-content table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .message.assistant .message-content a {
            color: #667eea;
            text-decoration: none;
        }

        .message.assistant .message-content a:hover {
            text-decoration: underline;
        }

        .message.assistant .message-content hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 1em 0;
        }

        .message.assistant .message-content strong {
            font-weight: 600;
        }

        .message.assistant .message-content em {
            font-style: italic;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        #sendButton {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #sendButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #sendButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .model-selector {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .model-selector select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }


        .web-result {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .web-result-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .web-result-url {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¤– Ollama Chat</h1>
            <p>Chat with your LLM models</p>
        </div>
        <div class="model-selector">
            <label for="modelSelect">Model: </label>
            <select id="modelSelect">
                <option value="gemma3:270m">gemma3:270m</option>
                <option value="gemma3:1b">gemma3:1b</option>
            </select>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-content">
                    <p>Hello! I'm ready to chat. What would you like to know?</p>
                </div>
            </div>
        </div>
        <div class="input-container">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Type your message here..."
                autocomplete="off"
            >
            <button id="sendButton">Send</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const modelSelect = document.getElementById('modelSelect');
        const OLLAMA_API = '/api/generate';
        
        // Store conversation history
        const conversationHistory = [];

        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isUser) {
                // User messages: plain text
                contentDiv.textContent = content;
            } else {
                // Assistant messages: render markdown
                contentDiv.innerHTML = marked.parse(content);
            }
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Store in conversation history
            conversationHistory.push({
                role: isUser ? 'user' : 'assistant',
                content: content
            });
        }

        function addLoadingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'loadingMessage';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<div class="loading"></div>';
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        async function browseWeb(url) {
            try {
                const response = await fetch(`/browse?url=${encodeURIComponent(url)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error browsing web:', error);
                return { error: error.message };
            }
        }

        async function searchWeb(query) {
            try {
                const response = await fetch(`/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error searching web:', error);
                return { error: error.message, results: [] };
            }
        }

        function needsMoreInfo(response) {
            // Check if LLM response indicates it doesn't have enough information
            const lowerResponse = response.toLowerCase();
            const indicators = [
                "i don't know",
                "i'm not sure",
                "i don't have",
                "i cannot",
                "i can't",
                "i don't have access",
                "i don't have information",
                "i don't have enough",
                "i'm not able",
                "i'm unable",
                "i lack",
                "i don't possess",
                "i'm not aware",
                "i don't recall",
                "i'm not familiar",
                "i don't have the",
                "i don't have current",
                "i don't have recent",
                "i don't have up-to-date",
                "i don't have the latest",
                "i don't have access to",
                "i cannot access",
                "i don't have real-time",
                "i don't have live",
                "i don't have current information",
                "i don't have recent information",
                "i don't have up-to-date information",
                "i don't have the latest information"
            ];
            
            return indicators.some(indicator => lowerResponse.includes(indicator));
        }

        function extractSearchQuery(userMessage, llmResponse) {
            // Extract a search query from the user's message
            // Remove common question words and keep the main topic
            let query = userMessage;
            
            // Remove question words
            query = query.replace(/^(what|who|when|where|why|how|is|are|can|could|would|should|do|does|did)\s+/i, '');
            
            // Remove trailing question mark
            query = query.replace(/\?$/, '');
            
            // Limit length
            if (query.length > 100) {
                query = query.substring(0, 100);
            }
            
            return query.trim();
        }


        function displayWebResult(result) {
            if (result.error) {
                addMessage(`Error browsing web: ${result.error}`, false);
                return;
            }
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'message assistant';
            resultDiv.innerHTML = `
                <div class="message-content">
                    <div class="web-result">
                        <div class="web-result-title">ðŸ“„ ${result.title || 'Web Page Content'}</div>
                        <div class="web-result-url">ðŸ”— ${result.url}</div>
                        <div>${result.content.substring(0, 500)}${result.content.length > 500 ? '...' : ''}</div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(resultDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function buildPromptWithContext(currentMessage, webContext = null) {
            let prompt = '';
            
            // Add web browsing context if available
            if (webContext && !webContext.error) {
                prompt += 'Web browsing information:\n';
                prompt += `URL: ${webContext.url}\n`;
                prompt += `Title: ${webContext.title}\n`;
                prompt += `Content: ${webContext.content}\n\n`;
                prompt += '---\n\n';
            }
            
            // Add previous conversation context as a list (excluding the current message)
            if (conversationHistory.length > 0) {
                prompt += 'Previous conversation context:\n\n';
                conversationHistory.forEach((msg, index) => {
                    if (msg.role === 'user') {
                        prompt += `${index + 1}. Question: ${msg.content}\n`;
                    } else {
                        prompt += `   Answer: ${msg.content}\n\n`;
                    }
                });
                prompt += '\n---\n\n';
            }
            
            // Add current message
            prompt += `Current question: ${currentMessage}`;
            
            return prompt;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            const selectedModel = modelSelect.value;
            
            // Build prompt with conversation context (before adding current message to history)
            const promptWithContext = buildPromptWithContext(message);
            
            // Add user message to UI (this will also add it to history)
            addMessage(message, true);
            messageInput.value = '';
            sendButton.disabled = true;

            // Add loading indicator
            addLoadingMessage();

            try {
                const response = await fetch(OLLAMA_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        prompt: promptWithContext,
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const assistantResponse = data.response || 'No response received';
                
                // Check if LLM needs more information
                if (needsMoreInfo(assistantResponse)) {
                    removeLoadingMessage();
                    addMessage(assistantResponse + '\n\nðŸ” Searching and browsing the web for more information...', false);
                    
                    // Perform web search to find relevant URLs
                    const searchQuery = extractSearchQuery(message, assistantResponse);
                    const searchData = await searchWeb(searchQuery);
                    
                    if (searchData.results && searchData.results.length > 0) {
                        // Browse the top search result URLs
                        const browsedContent = [];
                        const maxBrowse = Math.min(2, searchData.results.length); // Browse top 2 results
                        
                        for (let i = 0; i < maxBrowse; i++) {
                            const result = searchData.results[i];
                            if (result.url) {
                                try {
                                    const browseResult = await browseWeb(result.url);
                                    if (browseResult && !browseResult.error) {
                                        browsedContent.push(browseResult);
                                        
                                        // Display browsed content
                                        displayWebResult(browseResult);
                                    }
                                } catch (error) {
                                    console.error('Error browsing URL:', error);
                                }
                            }
                        }
                        
                        if (browsedContent.length > 0) {
                            // Combine all browsed content
                            let combinedContent = 'Web browsing information from multiple sources:\n\n';
                            browsedContent.forEach((content, idx) => {
                                combinedContent += `Source ${idx + 1}:\n`;
                                combinedContent += `URL: ${content.url}\n`;
                                combinedContent += `Title: ${content.title}\n`;
                                combinedContent += `Content: ${content.content}\n\n`;
                            });
                            
                            // Ask LLM again with browsed content
                            addLoadingMessage();
                            const enhancedPrompt = buildPromptWithContext(message) + 
                                '\n\n' + combinedContent + 
                                '\n\nPlease provide a comprehensive answer using the information from the web sources above.';
                            
                            const enhancedResponse = await fetch(OLLAMA_API, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    model: selectedModel,
                                    prompt: enhancedPrompt,
                                    stream: false
                                })
                            });
                            
                            if (enhancedResponse.ok) {
                                const enhancedData = await enhancedResponse.json();
                                removeLoadingMessage();
                                const enhancedAnswer = enhancedData.response || 'No response received';
                                addMessage('ðŸ“š Updated answer with information from web sources:\n\n' + enhancedAnswer, false);
                            } else {
                                removeLoadingMessage();
                                addMessage('Error getting enhanced response with web browsing results.', false);
                            }
                        } else {
                            addMessage('Could not browse the search results. Please try rephrasing your question.', false);
                        }
                    } else {
                        addMessage('No search results found. Please try rephrasing your question.', false);
                    }
                } else {
                    removeLoadingMessage();
                    addMessage(assistantResponse, false);
                }
            } catch (error) {
                removeLoadingMessage();
                addMessage(`Error: ${error.message}. Make sure the server is running.`, false);
                console.error('Error:', error);
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
            }
        }


        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });

        // Focus input on load
        messageInput.focus();
    </script>
</body>
</html>
